<!-- preview.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Gemini Multimodal Preview</title>
  </head>
  <body>
    <h1>Multimodal Image+Prompt Preview</h1>

    <!-- 出力表示 -->
    <div>
      <p id="text"></p>
      <img id="preview" alt="Generated by Gemini" />
    </div>

    <!-- 入力欄 -->
    <div>
      <label for="promptInput">Prompt:</label>
      <input
        id="promptInput"
        type="text"
        placeholder="Enter prompt"
        style="width:80%;"
      />
      <br/><br/>
      <label for="imageInput">Upload Image:</label>
      <input id="imageInput" type="file" accept="image/*" />
      <button id="generateBtn">Generate</button>
    </div>

    <script>
      document.getElementById("generateBtn").addEventListener("click", () => {
        const prompt = document.getElementById("promptInput").value;
        const fileInput = document.getElementById("imageInput");
        if (!fileInput.files.length) {
          return alert("Please select an image to send.");
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = async () => {
          // 「data:…;base64,」部分を除去して純粋なBase64だけ取り出す
          const b64 = reader.result.split(",")[1];
          try {
            const res = await fetch("/api/gen-image", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                prompt,
                imageBase64: b64,
                mimeType: file.type
              }),
            });
            const { text, imageBase64 } = await res.json();
            document.getElementById("text").innerText = text || "";
            document.getElementById("preview").src =
              "data:image/png;base64," + imageBase64;
          } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
          }
        };
        reader.readAsDataURL(file);
      });
    </script>
  </body>
</html>